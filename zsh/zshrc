#!/usr/bin/zsh
# zmodload zsh/zprof
source $HOME/.aliases.zsh
source $HOME/.env
source $HOME/.zshkeybindings.zsh
PATH="${PATH}:$HOME/bin:$HOME/.local/bin:$HOME/.krew/bin:$HOME/.npm-global/bin"
export PATH
#
# [[ -r ~/git/znap/znap/znap.zsh ]] ||
#   git clone --depth 1 -- \
#     https://github.com/marlonrichert/zsh-snap.git ~/git/znap/znap
source ~/git/znap/znap/znap.zsh # Start Znap
znap source ohmyzsh/ohmyzsh plugins/{dirhistory,gitfast}
znap source ajeetdsouza/zoxide
znap source Aloxaf/fzf-tab
znap source zsh-users/zsh-autosuggestions
znap source zsh-users/zsh-history-substring-search
znap source zdharma-continuum/fast-syntax-highlighting
#znap source jeffreytse/zsh-vi-mode

source /usr/share/fzf/key-bindings.zsh
source /usr/share/fzf/completion.zsh
source $HOME/.config/flavours/fzf.sh

THEME_FILE="$HOME/.config/fsh/current-theme"
CACHE_FILE="$HOME/.cache/fsh-last-theme"

if [[ -f $THEME_FILE ]]; then
  theme=$(<"$THEME_FILE")

  if [[ ! -f $CACHE_FILE || $(<"$CACHE_FILE") != "$theme" ]]; then
    fast-theme "$theme" >/dev/null 2>&1
    print -r -- "$theme" >| "$CACHE_FILE"
  fi
fi
compdef _ssh_hosts sshpass s sr
compdef _kubectl kubecolor
# Make autocomplete work for the jctl() function
compdef _journalctl jctl
# Sourcing k8s related stuff if using k8s
#if command -v kubectl &> /dev/null
#then
#    source $HOME/.functions_k8s
#fi

znap eval oh-my-posh 'oh-my-posh init zsh --config $HOME/.config/oh-my-posh/omp.yaml'
source $HOME/.zstyle.zsh
# Ensure up and down arrow works for searching history
bindkey '^[0A' history-substring-search-up
bindkey '^[0B' history-substring-search-down
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
zstyle ':znap:*:*' git-maintenance off
# Prompt char based on viins and vicmd
export SHELL_PROMPT='❯'
_omp_redraw-prompt() {
  local precmd
  for precmd in "${precmd_functions[@]}"; do
    "$precmd"
  done

  zle .reset-prompt
}
function zle-line-init zle-keymap-select {
    case ${KEYMAP} in
       (vicmd)       SHELL_PROMPT='❮' ;;
       (main|viins)  SHELL_PROMPT='❯' ;;
       (*)           SHELL_PROMPT='❮' ;;
    esac
    _omp_redraw-prompt
}

zle -N zle-line-init
zle -N zle-keymap-select
znap prompt
# zprof
