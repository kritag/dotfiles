#!/usr/bin/env bash
set -euo pipefail

BROWSER="edge"

# Adjust if your binary is different
EDGE_BIN="${EDGE_BIN:-microsoft-edge-stable}"

DESKTOP_DIR="$HOME/.local/share/applications"
ICON_DIR="$HOME/.local/share/icons/webapps"

mkdir -p "$DESKTOP_DIR"
mkdir -p "$ICON_DIR"

slugify() {
  echo "$1" \
    | tr '[:upper:]' '[:lower:]' \
    | tr -cs 'a-z0-9' '-' \
    | sed 's/^-*//; s/-*$//'
}

create_webapp() {
  local APP_NAME="$1"
  local URL="$2"

  local SLUG
  SLUG=$(slugify "$APP_NAME")

  local DESKTOP_FILE="$DESKTOP_DIR/webapp-$BROWSER-$SLUG.desktop"
  local ICON_FILE="$ICON_DIR/$BROWSER-$SLUG.png"

  echo "→ Creating Edge WebApp: $APP_NAME"

  # Try favicon
  local DOMAIN
  DOMAIN=$(echo "$URL" | awk -F/ '{print $3}')
  local FAVICON_URL="https://$DOMAIN/favicon.ico"

  if command -v curl >/dev/null; then
    if curl -fsSL "$FAVICON_URL" -o "$ICON_FILE.tmp"; then
      if command -v convert >/dev/null; then
        convert "$ICON_FILE.tmp" "$ICON_FILE" 2>/dev/null || mv "$ICON_FILE.tmp" "$ICON_FILE"
      else
        mv "$ICON_FILE.tmp" "$ICON_FILE"
      fi
      echo "  Saved icon."
    else
      echo "  No favicon found."
    fi
  fi

  cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Name=$APP_NAME (Edge)
Exec=$EDGE_BIN --app="$URL"
Terminal=false
Type=Application
Categories=Network;WebApp;
Icon=$ICON_FILE
EOF

  echo "✓ Created $DESKTOP_FILE"
}

remove_webapp() {
  local APP_NAME="$1"
  local SLUG
  SLUG=$(slugify "$APP_NAME")

  local DESKTOP_FILE="$DESKTOP_DIR/webapp-$BROWSER-$SLUG.desktop"
  local ICON_FILE="$ICON_DIR/$BROWSER-$SLUG.png"

  echo "→ Removing Edge WebApp: $APP_NAME"

  rm -f "$DESKTOP_FILE"
  rm -f "$ICON_FILE"

  echo "✓ Removed."
}

list_webapps() {
  echo "Edge WebApps:"
  ls "$DESKTOP_DIR"/webapp-$BROWSER-*.desktop 2>/dev/null \
    | sed "s#.*/webapp-$BROWSER-##; s/\.desktop//" \
    || echo "  (none)"
}

usage() {
  echo "Usage:"
  echo "  webapp-edge create \"Name\" https://url"
  echo "  webapp-edge remove \"Name\""
  echo "  webapp-edge list"
  exit 1
}

case "${1:-}" in
  create)
    [[ $# -eq 3 ]] || usage
    create_webapp "$2" "$3"
    ;;
  remove)
    [[ $# -eq 2 ]] || usage
    remove_webapp "$2"
    ;;
  list)
    list_webapps
    ;;
  *)
    usage
    ;;
esac
